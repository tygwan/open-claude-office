# DXTnavis - Architecture Analysis

> Generated by code-analyst | 2026-02-22
> Source: /home/coffin/dev/DXTnavis

---

## Tech Stack

| Technology | Version | Role | Evidence |
|-----------|---------|------|----------|
| C# | 7.3+ (implied by .NET 4.8) | Primary language | `DXTnavis.csproj:12` (TargetFrameworkVersion v4.8) |
| .NET Framework | 4.8 | Runtime | `DXTnavis.csproj:12` |
| WPF (XAML) | 4.8 | UI framework | `Views/DXwindow.xaml:1` (UserControl), `DXTnavis.csproj:255` (Page) |
| Navisworks API (.NET) | 2025 | BIM model access (read) | `DXTnavis.csproj:38-81` (11 Autodesk references) |
| Navisworks COM API | 2025 | BIM model write | `Services/PropertyWriteService.cs:91-117` (ComApiBridge) |
| Navisworks TimeLiner | 2025 | 4D simulation | `Services/TimeLinerService.cs:5` (Autodesk.Navisworks.Api.Timeliner) |
| Newtonsoft.Json | 13.0.4 | JSON serialization | `packages.config:3` |
| System.Text.Json | 7.0.0 | JSON serialization (modern) | `packages.config:9` |
| MSBuild | 15.0 | Build system | `DXTnavis.csproj:2` (ToolsVersion 15.0) |
| Visual Studio | 2022 (17.14) | IDE | `DXTnavis.sln:4` (VisualStudioVersion 17.14) |
| Astro | 5.x | Portfolio site | `site/package.json` |
| NuGet | - | Package manager | `packages.config:1` |

---

## Architecture Pattern

**MVVM (Model-View-ViewModel)** with **Partial Class decomposition** and **Service Layer**.

The project follows a classic WPF MVVM architecture:
- **Models** define data structures (14 model files)
- **ViewModels** implement presentation logic with `INotifyPropertyChanged` (11 files, with the main ViewModel split into 7 partial classes)
- **Views** contain XAML UI definitions
- **Services** encapsulate Navisworks API interactions and business logic (20 service files)
- **Converters** provide XAML value converters
- **Helpers** provide utility classes (RelayCommand)

Evidence: `ViewModels/DXwindowViewModel.cs:22` implements `INotifyPropertyChanged, IDisposable`; `Helpers/RelayCommand.cs` provides `ICommand` relay pattern.

---

## Directory Structure

```
DXTnavis/                          Total: ~58 .cs files, ~18,916 LOC (C#) + ~1,485 LOC (XAML)
├── DX.cs                          Entry point (80 LOC) - Plugin registration
├── DXwindow.xaml                  Legacy UserControl (empty)
├── DXwindow.xaml.cs               Legacy code-behind (28 LOC)
├── Models/                        14 files, ~1,200 LOC
│   ├── HierarchicalPropertyRecord.cs
│   ├── TreeNodeModel.cs
│   ├── PropertyInfo.cs
│   ├── ScheduleData.cs            Phase 8 - schedule model
│   ├── AWP4DOptions.cs            Phase 8 - pipeline options
│   ├── AutomationResult.cs        Phase 8 - execution results
│   ├── ValidationResult.cs        Phase 8 - validation
│   ├── ObjectGroupModel.cs        Phase 12 - grouped data
│   ├── PropertyRecord.cs          Phase 12 - simplified property
│   ├── FilterOption.cs            Phase 12 - checkbox filter
│   ├── DateMode.cs                Phase 13 - date mode enum
│   ├── UnifiedObjectRecord.cs     Phase 16 - unified export
│   └── Geometry/                  Phase 15
│       ├── Point3D.cs
│       ├── BBox3D.cs
│       └── GeometryRecord.cs
├── ViewModels/                    11 files, ~6,700 LOC
│   ├── DXwindowViewModel.cs       Core (1,530 LOC)
│   ├── DXwindowViewModel.Export.cs  (743 LOC)
│   ├── DXwindowViewModel.Filter.cs  (144 LOC)
│   ├── DXwindowViewModel.Search.cs  (110 LOC)
│   ├── DXwindowViewModel.Selection.cs (219 LOC)
│   ├── DXwindowViewModel.Snapshot.cs  (311 LOC)
│   ├── DXwindowViewModel.Tree.cs    (181 LOC)
│   ├── AWP4DViewModel.cs           (609 LOC)
│   ├── CsvViewerViewModel.cs       (509 LOC)
│   ├── ScheduleBuilderViewModel.cs  (968 LOC)
│   ├── ObjectGroupViewModel.cs
│   ├── HierarchyNodeViewModel.cs
│   └── PropertyItemViewModel.cs
├── Views/                         1 file
│   └── DXwindow.xaml              Main UI (~1,473 LOC XAML)
├── Services/                      20 files, ~9,500 LOC
│   ├── NavisworksDataExtractor.cs  (844 LOC) - Core data extraction
│   ├── NavisworksSelectionService.cs - 3D selection
│   ├── PropertyWriteService.cs     (387 LOC) - ComAPI write
│   ├── SelectionSetService.cs      (516 LOC) - Set creation
│   ├── TimeLinerService.cs         (803 LOC) - TimeLiner tasks
│   ├── AWP4DAutomationService.cs   (420 LOC) - Pipeline orchestrator
│   ├── ObjectMatcher.cs            (401 LOC) - SyncID matching
│   ├── AWP4DValidator.cs           (406 LOC) - Pre/Post validation
│   ├── ScheduleCsvParser.cs        (547 LOC) - CSV parsing
│   ├── SnapshotService.cs          (915 LOC) - Viewport capture
│   ├── DisplayStringParser.cs      - Value parsing
│   ├── FullModelExporterService.cs
│   ├── PropertyFileWriter.cs
│   ├── HierarchyFileWriter.cs
│   ├── SetCreationService.cs
│   ├── ValidationService.cs        (433 LOC)
│   ├── LoadHierarchyService.cs     (428 LOC)
│   ├── UnifiedCsvExporter.cs       (325 LOC)
│   └── Geometry/                   Phase 15
│       ├── GeometryExtractor.cs    (423 LOC)
│       ├── GeometryFileWriter.cs   (407 LOC)
│       ├── MeshExtractor.cs        (490 LOC)
│       └── GeometryRdfIntegrator.cs
├── Converters/
│   └── BoolToVisibilityConverter.cs
├── Helpers/
│   └── RelayCommand.cs
├── Properties/
│   └── AssemblyInfo.cs
├── Resources/
│   ├── icon_16x16.png
│   └── icon_32x32.png
├── docs/                          Project documentation
├── site/                          Astro portfolio site
└── snapshots/                     UI screenshots
```

---

## Key Modules

| Module | Files | LOC | Responsibility |
|--------|-------|-----|----------------|
| DXwindowViewModel (all partials) | 7 | ~3,238 | Core UI logic: hierarchy loading, filtering, selection, 3D control, search, export, snapshots |
| AWP 4D Pipeline | 8 | ~3,500 | CSV parsing, object matching, property write, selection sets, TimeLiner tasks |
| NavisworksDataExtractor | 1 | 844 | Recursive model traversal, property extraction, grouped data extraction |
| Geometry Export System | 4 | ~1,730 | BoundingBox extraction, mesh extraction, manifest/CSV output, RDF integration |
| ScheduleBuilderViewModel | 1 | 968 | Schedule CSV generation, direct TimeLiner execution, DryRun mode |
| CsvViewerViewModel | 1 | 509 | External CSV file loading, filtering, encoding detection |
| UnifiedCsvExporter | 1 | 325 | Hierarchy + Geometry merge into single CSV for ontology |

---

## Data Flow

```
                                  Navisworks 2025
                                       │
                        ┌──────────────┼──────────────┐
                        │              │              │
                   .NET API       COM API         TimeLiner API
                   (Read)         (Write)         (Read/Write)
                        │              │              │
                        ▼              ▼              ▼
              NavisworksDataExtractor  PropertyWriteService  TimeLinerService
                        │              │              │
                ┌───────┴───────┐      │              │
                │               │      │              │
         HierarchicalRecords  ObjectGroupModels       │
                │               │      │              │
                ▼               ▼      ▼              ▼
           DXwindowViewModel ◄──────────────── AWP4DAutomationService
                │                                     │
         ┌──────┼──────┐                      ┌───────┼──────┐
         │      │      │                      │       │      │
     TreeView DataGrid 3D Control        CSV Parse  Match  Validate
         │      │      │
         ▼      ▼      ▼
     CSV Export  Search  Filter → Schedule Builder → Direct TimeLiner
```

### AWP 4D Automation Pipeline (5-phase)

```
CSV File → ScheduleCsvParser → ObjectMatcher → PropertyWriteService → SelectionSetService → TimeLinerService
  (1)           (2)                (3)                (4)                    (5)
```

Evidence: `Services/AWP4DAutomationService.cs:51-300` orchestrates the full pipeline.

---

## Code Metrics

| Metric | Value |
|--------|-------|
| C# Source Files | 58 |
| C# Lines of Code | 18,916 |
| XAML Lines | ~1,485 |
| Total LOC (code) | ~20,401 |
| Models | 14 classes |
| ViewModels | 11 files (7 partials for main VM) |
| Services | 20 files |
| Views | 1 main XAML |
| Converters | 1 |
| Helpers | 1 (RelayCommand) |
| NuGet Packages | 10 |
| Autodesk API References | 11 |
| Git Commits | 40 |
| Development Period | 2025-12-29 to 2026-02-10 (44 days) |
| Releases | 16+ versions (v0.0.1 to v1.4.0) |

---

## Dependencies

### Autodesk Navisworks 2025 APIs (11 references)

| Dependency | Role | Evidence |
|-----------|------|----------|
| Autodesk.Navisworks.Api | Core .NET API (read-only model access) | `DXTnavis.csproj:38` |
| Autodesk.Navisworks.Automation | Batch/automation operations | `DXTnavis.csproj:42` |
| Autodesk.Navisworks.ComApi | COM bridge for write operations | `DXTnavis.csproj:50` |
| Autodesk.Navisworks.Controls | WPF control hosting | `DXTnavis.csproj:54` |
| Autodesk.Navisworks.Interop.ComApi | COM interop types | `DXTnavis.csproj:58` |
| Autodesk.Navisworks.Interop.ComApiAutomation | COM automation interop | `DXTnavis.csproj:62` |
| Autodesk.Navisworks.Interop.Timeliner | TimeLiner COM interop | `DXTnavis.csproj:66` |
| Autodesk.Navisworks.Resolver | Assembly resolver | `DXTnavis.csproj:70` |
| Autodesk.Navisworks.Takeoff | Quantification features | `DXTnavis.csproj:74` |
| Autodesk.Navisworks.Timeliner | 4D simulation API | `DXTnavis.csproj:78` |
| Autodesk.Navisworks.Clash | Clash detection | `DXTnavis.csproj:46` |

### NuGet Packages (10)

| Package | Version | Role |
|---------|---------|------|
| Newtonsoft.Json | 13.0.4 | JSON serialization |
| System.Text.Json | 7.0.0 | Modern JSON (export) |
| Microsoft.Bcl.AsyncInterfaces | 7.0.0 | Async patterns |
| System.Buffers | 4.5.1 | Memory buffers |
| System.Memory | 4.5.5 | Span/Memory types |
| System.Numerics.Vectors | 4.5.0 | SIMD operations |
| System.Runtime.CompilerServices.Unsafe | 6.0.0 | Low-level runtime |
| System.Text.Encodings.Web | 7.0.0 | HTML/URL encoding |
| System.Threading.Tasks.Extensions | 4.5.4 | ValueTask support |
| System.ValueTuple | 4.5.0 | Tuple support |

### Disabled Dependencies (Phase 14/15 - temporarily disabled)

| Package | Version | Role | Evidence |
|---------|---------|------|----------|
| dotNetRdf.Core | 3.4.1 | RDF/SPARQL ontology | `DXTnavis.csproj:128-131` (commented out) |
| YamlDotNet | 15.1.0 | YAML parsing | `DXTnavis.csproj:137-139` (commented out) |
| FuzzySharp | 2.0.2 | Fuzzy string matching | `DXTnavis.csproj:141-143` (commented out) |
| AngleSharp | 1.3.0 | HTML parsing | `DXTnavis.csproj:145-147` (commented out) |
| HtmlAgilityPack | 1.12.3 | HTML scraping | `DXTnavis.csproj:149-151` (commented out) |
| Neo4j.Driver | 5.15.0 | Graph database | `DXTnavis.csproj:157-159` (commented out) |

---

## API Surface

### Plugin Entry Point

| Method | Signature | Description | Evidence |
|--------|-----------|-------------|----------|
| DX.Execute | `int Execute(params string[])` | Plugin activation (singleton window) | `DX.cs:27` |

### Navisworks API Usage Strategy

| Operation | API Used | Reason | Evidence |
|-----------|----------|--------|----------|
| Property Read | .NET API | Standard read access | `Services/NavisworksDataExtractor.cs:82-213` |
| Property Write | COM API | .NET API is read-only for properties | `Services/PropertyWriteService.cs:88-133` |
| Selection Set Create | .NET API | AddCopy/InsertCopy methods | `Services/SelectionSetService.cs` |
| TimeLiner Task Create | .NET API | TasksCopyFrom method | `Services/TimeLinerService.cs:209` |
| Viewport Capture | COM API + .NET API | Hybrid for image export | `Services/SnapshotService.cs` |
| BoundingBox Extract | .NET API | ModelItem.BoundingBox() | `Services/Geometry/GeometryExtractor.cs:50` |

### ICommand Surface (UI Commands)

| Command | Category | Evidence |
|---------|----------|----------|
| LoadHierarchyCommand | Data Loading | `DXwindowViewModel.cs:589` |
| ApplyFilterCommand | Filtering | `DXwindowViewModel.cs:591` |
| ClearFilterCommand | Filtering | `DXwindowViewModel.cs:593` |
| SelectIn3DCommand | 3D Control | `DXwindowViewModel.cs:596` |
| ShowOnlyFilteredCommand | 3D Control | `DXwindowViewModel.cs:600` |
| ShowAllObjectsCommand | 3D Control | `DXwindowViewModel.cs:604` |
| ZoomToFilteredCommand | 3D Control | `DXwindowViewModel.cs:607` |
| SearchObjectCommand | Search | `DXwindowViewModel.cs:633` |
| ExportAllPropertiesCommand | Export | `DXwindowViewModel.cs:578` |
| ExportAllHierarchyCommand | Export | `DXwindowViewModel.cs:580` |
| ExportGeometryCommand | Export | `DXwindowViewModel.cs:583` |
| ExportUnifiedCsvCommand | Export | `DXwindowViewModel.cs:586` |
| CaptureViewCommand | Snapshot | `DXwindowViewModel.cs:611` |
| ResetToHomeCommand | Navigation | `DXwindowViewModel.cs:628` |
| DirectExecuteCommand | Schedule/TimeLiner | `ScheduleBuilderViewModel.cs:118` |

---

## Configuration

### Build Configuration

| Setting | Value | Evidence |
|---------|-------|----------|
| Output Type | Library (DLL) | `DXTnavis.csproj:8` |
| Target Framework | .NET Framework 4.8 | `DXTnavis.csproj:12` |
| Platform Target | x64 | `DXTnavis.csproj:24` |
| Post-Build Deploy | Auto-copy to Navisworks Plugins/ | `DXTnavis.csproj:280-286` |

### Assembly Binding Redirects

| Assembly | Redirect | Evidence |
|----------|----------|----------|
| System.Text.Json | 0.0.0.0-8.0.0.0 -> 7.0.0.0 | `app.config:7` |
| System.Runtime.CompilerServices.Unsafe | 0.0.0.0-6.0.0.0 -> 6.0.0.0 | `app.config:11` |

---

## Build & Deployment

```
Build:
  dotnet build DXTnavis.csproj -c Debug    (or Visual Studio 2022)
  ↓
PostBuild Script (DXTnavis.csproj:280-286):
  1. Close Navisworks if running (Stop-Process -Name Roamer)
  2. Copy DXTnavis.dll to C:\Program Files\Autodesk\Navisworks Manage 2025\Plugins\
  3. Copy .pdb for debugging
  ↓
Deployment:
  Launch Navisworks 2025 → Home tab → DXTnavis button

Alternative:
  deploy.bat / deploy.ps1 (manual deploy scripts)
```

---

## Design Decisions

### ADR-001: ComAPI for Property Write

- **CONTEXT**: Need to write custom properties to BIM model objects for 4D simulation tagging.
- **DECISION**: Use Navisworks COM API (`SetUserDefined()`) instead of .NET API.
- **RATIONALE**: .NET API properties are read-only by design. COM API provides `InwGUIPropertyNode2.SetUserDefined()` for custom property creation.
- **ALTERNATIVES**: External database mapping (rejected: requires separate sync), IFC file modification (rejected: destructive).
- **EVIDENCE**: `Services/PropertyWriteService.cs:91-117`, `docs/adr/ADR-001-ComAPI-Property-Write.md`

### ADR-002: Partial Class Decomposition for ViewModel

- **CONTEXT**: Main ViewModel grew to 2,213 LOC, becoming difficult to maintain.
- **DECISION**: Split into 7 partial classes by responsibility (Core, Filter, Search, Selection, Snapshot, Tree, Export).
- **RATIONALE**: Maintains single ViewModel binding while improving code organization. No architectural change needed.
- **ALTERNATIVES**: Multiple ViewModels (rejected: complex inter-VM communication), UserControl extraction (rejected: tight coupling to main state).
- **EVIDENCE**: `ViewModels/DXwindowViewModel.*.cs` (7 files), commit `da035ee`

### ADR-003: Grouped Data Structure (445K -> 5K)

- **CONTEXT**: Loading 445K individual property records caused severe UI performance issues.
- **DECISION**: Group properties by object (1 object = 1 group), reducing 445K records to ~5K groups.
- **RATIONALE**: 99% reduction in iteration count for Select All, filtering, and rendering operations.
- **ALTERNATIVES**: Virtualization only (rejected: still slow for Select All), pagination (rejected: poor UX for BIM workflows).
- **EVIDENCE**: `Models/ObjectGroupModel.cs`, `Services/NavisworksDataExtractor.cs:617-843`, CHANGELOG `[1.0.0]`

### ADR-004: Synthetic ID Generation for Hierarchy Preservation

- **CONTEXT**: Some BIM formats (CATIA, PDMS) do not provide InstanceGuid, causing hierarchy flattening.
- **DECISION**: Generate deterministic synthetic GUIDs using MD5 hash of (SourceGuid + AuthoringID or HierarchyPath).
- **RATIONALE**: Preserves parent-child relationships across all BIM formats. Deterministic IDs enable consistent ontology mapping.
- **ALTERNATIVES**: Random GUIDs (rejected: non-deterministic), index-based IDs (rejected: fragile across sessions).
- **EVIDENCE**: `Services/Geometry/GeometryExtractor.cs:271-404`, CHANGELOG `[1.3.0]`

### ADR-005: Dual API Strategy (.NET + COM)

- **CONTEXT**: Some Navisworks operations require .NET API, others require COM API.
- **DECISION**: Use .NET API for reads and most writes, COM API only for Property Write.
- **RATIONALE**: .NET API is safer and more performant. COM API is only needed where .NET API has gaps (property write, some viewport operations).
- **ALTERNATIVES**: Full COM API (rejected: verbose, less type-safe), reverse engineering (rejected: unsupported).
- **EVIDENCE**: `README.md:328-332` (API Usage Strategy table)

---

## Key Findings

### Strengths

1. **Clean MVVM separation** - Models, ViewModels, Services clearly separated. INotifyPropertyChanged used consistently. `DXwindowViewModel.cs:22`
2. **Robust error handling** - `[HandleProcessCorruptedStateExceptions]` attributes handle Navisworks API's notorious `AccessViolationException`. `NavisworksDataExtractor.cs:30-31`
3. **Performance optimization** - 445K->5K grouped data structure shows sophisticated understanding of WPF data binding bottlenecks. `ObjectGroupModel.cs:1-258`
4. **Complete 4D automation pipeline** - CSV->Match->Write->Set->TimeLiner pipeline with validation, dry run, and progress tracking. `AWP4DAutomationService.cs:51-300`
5. **Debounce patterns** - 200-300ms debounce timers prevent UI thrashing during rapid filter/selection changes. `DXwindowViewModel.cs:700-720`
6. **Thread safety awareness** - Comments and code explicitly handle UI thread requirements for Navisworks API calls. `DXwindowViewModel.cs:1456` (Error7 note)
7. **Progressive deployment** - PostBuild auto-deploy to Navisworks Plugins directory with running-process detection. `DXTnavis.csproj:280-286`

### Trade-offs

1. **Single XAML file** - All UI in one DXwindow.xaml (~1,485 LOC). Could benefit from UserControl extraction for tabs.
2. **Disabled ontology features** - Phase 14 (dotNetRdf, Neo4j) disabled due to plugin loading conflicts. `DXTnavis.csproj:127-160` (commented out blocks)
3. **No unit tests** - Zero test files found. BIM plugin testing requires Navisworks runtime, making automated testing challenging.
4. **COM API fragility** - Property write relies on COM interop which can throw `COMException` and `AccessViolationException`. Mitigated by retry logic. `PropertyWriteService.cs:54-83`
5. **x64 platform lock** - Must run as x64 due to Navisworks requirement. Limits deployment flexibility. `DXTnavis.csproj:24`
